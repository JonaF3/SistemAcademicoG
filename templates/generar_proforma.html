{% extends "base.html" %}

{% block page_title %}Generar Proforma{% endblock %}
{% block title %}Generar Proforma{% endblock %}

{% block content %}
<div style="max-width: 1000px; margin: 0 auto;">
    <div style="text-align: center; margin-bottom: 50px;">
        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px; margin: 0 auto 20px; box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3);">
            üìÑ
        </div>
        <h2 style="color: #1e293b; font-size: 2.2em; font-weight: 700; margin-bottom: 10px;">Generar Proforma</h2>
        <p style="color: #64748b; font-size: 1.1em;">
            Selecciona tu perfil y las materias que cursar√°s este semestre
        </p>
    </div>

    {% if estudiantes %}
    <form method="POST" action="{{ url_for('crear_proforma') }}" id="formProforma">
        <!-- Paso 1: Selecci√≥n de Estudiante -->
        <div style="background: white; border: 3px solid #e2e8f0; border-radius: 20px; padding: 35px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
                <div style="width: 45px; height: 45px; background: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.2em;">
                    1
                </div>
                <h3 style="color: #1e293b; font-size: 1.4em; font-weight: 700; margin: 0;">Selecciona tu Perfil</h3>
            </div>
            
            <div class="form-group">
                <label for="id_estudiante">Estudiante</label>
                <select id="id_estudiante" name="id_estudiante" required onchange="cargarAsignaturas()" style="font-size: 1.05em; padding: 16px;">
                    <option value="">-- Selecciona tu c√≥digo de estudiante --</option>
                    {% for estudiante in estudiantes %}
                    <option value="{{ estudiante.id }}" data-curso="{{ estudiante.curso }}">
                        {{ estudiante.codigo_estudiante }} | {{ estudiante.nombre }} {{ estudiante.apellido }} | {{ estudiante.curso }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <!-- Informaci√≥n del Curso (oculto inicialmente) -->
        <div id="info-curso" style="display: none; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 20px; padding: 35px; margin-bottom: 30px; border: 3px solid #3b82f6;">
            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div>
                    <div style="font-size: 3em; margin-bottom: 10px;">üìö</div>
                    <div style="color: #1e40af; font-size: 0.9em; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Curso Seleccionado</div>
                    <div id="nombre-curso" style="color: #1e3a8a; font-size: 1.8em; font-weight: 700;"></div>
                </div>
                <div style="width: 2px; background: rgba(30, 64, 175, 0.3);"></div>
                <div>
                    <div style="font-size: 3em; margin-bottom: 10px;">üí∞</div>
                    <div style="color: #1e40af; font-size: 0.9em; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Costo Total</div>
                    <div id="costo-curso" style="color: #10b981; font-size: 1.8em; font-weight: 700;"></div>
                </div>
            </div>
        </div>
        
        <!-- Paso 2: Selecci√≥n de Asignaturas -->
        <div id="asignaturas-container" style="display: none;">
            <div style="background: white; border: 3px solid #e2e8f0; border-radius: 20px; padding: 35px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
                    <div style="width: 45px; height: 45px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.2em;">
                        2
                    </div>
                    <h3 style="color: #1e293b; font-size: 1.4em; font-weight: 700; margin: 0;">Selecciona tus Asignaturas</h3>
                </div>
                
                <p style="color: #64748b; margin-bottom: 25px; font-size: 1.05em;">
                    Marca las materias que cursar√°s en este per√≠odo acad√©mico
                </p>
                
                <div id="lista-asignaturas" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                    <!-- Asignaturas se cargar√°n aqu√≠ -->
                </div>
            </div>
        </div>
        
        <!-- Bot√≥n de Env√≠o -->
        <div id="boton-container" style="display: none; text-align: center; margin-top: 40px;">
            <button type="submit" style="min-width: 350px; font-size: 1.15em; padding: 20px;">
                ‚úì Generar Mi Proforma
            </button>
        </div>
    </form>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">‚ö†Ô∏è</div>
        <p><strong>No hay estudiantes disponibles</strong></p>
        <p style="margin-top: 10px; font-size: 0.95em;">Todos los estudiantes ya tienen proformas pendientes o est√°n matriculados</p>
        <br>
        <a href="{{ url_for('registro') }}" class="btn-action" style="font-size: 1.1em; padding: 14px 30px;">
            ‚ûï Registrar Nuevo Estudiante
        </a>
    </div>
    {% endif %}
</div>

<script>
const costosPorCurso = {
    'Primer Curso': 300.00,
    'Segundo Curso': 340.00,
    'Tercer Curso': 450.00
};

async function cargarAsignaturas() {
    const select = document.getElementById('id_estudiante');
    const selectedOption = select.options[select.selectedIndex];
    const curso = selectedOption.getAttribute('data-curso');
    
    if (!curso) {
        document.getElementById('info-curso').style.display = 'none';
        document.getElementById('asignaturas-container').style.display = 'none';
        document.getElementById('boton-container').style.display = 'none';
        return;
    }
    
    // Mostrar informaci√≥n del curso
    document.getElementById('nombre-curso').textContent = curso;
    document.getElementById('costo-curso').textContent = '$' + costosPorCurso[curso].toFixed(2);
    document.getElementById('info-curso').style.display = 'block';
    
    // Cargar asignaturas
    try {
        const response = await fetch(`/obtener-asignaturas/${encodeURIComponent(curso)}`);
        const asignaturas = await response.json();
        
        const container = document.getElementById('lista-asignaturas');
        container.innerHTML = '';
        
        asignaturas.forEach(asignatura => {
            const div = document.createElement('div');
            div.style.cssText = `
                background: #f8fafc;
                padding: 25px;
                border-radius: 15px;
                border: 3px solid #e2e8f0;
                transition: all 0.3s ease;
                cursor: pointer;
            `;
            div.innerHTML = `
                <label style="display: flex; align-items: start; cursor: pointer; margin: 0;">
                    <input type="checkbox" name="asignaturas[]" value="${asignatura.id}" 
                           style="width: 24px; height: 24px; margin-right: 15px; margin-top: 5px; cursor: pointer; accent-color: #3b82f6;"
                           onchange="actualizarEstiloCheckbox(this)">
                    <div style="flex: 1;">
                        <div style="font-size: 1.15em; color: #1e293b; font-weight: 700; margin-bottom: 8px;">${asignatura.nombre}</div>
                        <div style="color: #64748b; font-size: 0.95em; line-height: 1.6;">${asignatura.descripcion || 'Sin descripci√≥n disponible'}</div>
                    </div>
                </label>
            `;
            container.appendChild(div);
        });
        
        document.getElementById('asignaturas-container').style.display = 'block';
        document.getElementById('boton-container').style.display = 'block';
        
    } catch (error) {
        console.error('Error al cargar asignaturas:', error);
        alert('‚ùå Error al cargar las asignaturas. Por favor, intente nuevamente.');
    }
}

function actualizarEstiloCheckbox(checkbox) {
    const div = checkbox.closest('div[style*="background"]');
    if (checkbox.checked) {
        div.style.borderColor = '#3b82f6';
        div.style.backgroundColor = '#dbeafe';
        div.style.transform = 'scale(1.03)';
        div.style.boxShadow = '0 8px 25px rgba(59, 130, 246, 0.25)';
    } else {
        div.style.borderColor = '#e2e8f0';
        div.style.backgroundColor = '#f8fafc';
        div.style.transform = 'scale(1)';
        div.style.boxShadow = 'none';
    }
}

document.getElementById('formProforma')?.addEventListener('submit', function(e) {
    const checkboxes = document.querySelectorAll('input[name="asignaturas[]"]:checked');
    if (checkboxes.length === 0) {
        e.preventDefault();
        alert('‚ö†Ô∏è Debes seleccionar al menos una asignatura');
    }
});
</script>
{% endblock %}